#!/bin/bash
#
#

REBOOT_WAIT=300 # in seconds
BACKUP_FILELIST="/etc/config/ /etc/dropbear/ /etc/firewall.user /etc/group /etc/hosts /etc/inittab /etc/passwd /etc/profile /etc/rc.local /etc/shadow /etc/shells /etc/sysctl.conf"

REBOOT_CMD="/sbin/reboot"
NO_REBOOT_CMD="/bin/true"
EPOCH=$(date +%s)

usage () {
  cat << EOF

Usage: $0 push [--no-reboot] [--wait secs] [--ip dest-ip] NAME [[--ip dest-ip] NAME] ...
       $0 pull [--ip dest-ip] NAME [[--ip dest-ip] NAME] ...
       $0 confirm NAME [NAME] ...

Manage remote uci configuration in NAME(s)

  -w, --wait NUM	After writing configuration, wait for NUM seconds
  				before reboot.
  -i, --ip HOST		Push the configuration to specified IP or host.
  				Applies only to the next NAME specified in command line.
  -n, --no-reboot	Prevent rebooting after apply

EOF
  exit 1
}

getIpFromCname () {
  CNAME=$1

  /home/guido/src/uci/uci -c $CNAME/etc/config/ get network.lan.ipaddr

  ### TODO: reimplementar sin usar uci,
  ###       usando bash + sed
}

pushConfigToIp () {
  CNAME=$1
  IPADDR=$2

  log $CNAME "Sending config with scp to $IPADDR ... "
  ERRLOG="/tmp/scp.${CNAME////}.$EPOCH"
  scp -pr $CNAME/etc $IPADDR:/tmp/etc.new.$EPOCH \
    >/dev/null 2>$ERRLOG
  RETVAL=$?
  log $CNAME "scp: $(<$ERRLOG)"
  [ $RETVAL -ne 0 ] && return
  

  log $CNAME "Config sent. Applying changes..."
  ERRLOG="/tmp/ssh.${CNAME////}.$EPOCH"
  ssh $IPADDR "
          (/bin/rm -r /etc.failsafe/ 2>/dev/null ;
          /bin/cp -a /etc /etc.failsafe \
       && /bin/rm -r $BACKUP_FILELIST \
       && /bin/mv /tmp/etc.new.$EPOCH/* /etc/ \
      )&&(/bin/sleep $REBOOT_WAIT \
       && $REBOOT_CMD & )" \
       >/dev/null 2>$ERRLOG
  RETVAL=$?
  [ -s $ERRLOG ] && log $CNAME "ssh: $(<$ERRLOG)"
  [ $RETVAL -ne 0 ] && return

  log $CNAME "Done.$([ $REBOOT_CMD != $NO_REBOOT_CMD ] && echo " Rebooting in $REBOOT_WAIT secs...")"
}

pullConfigFromIp () {
  CNAME=$1
  IPADDR=$2

  if ! [ -z "$(hg st $CNAME)" ] ; then
    log $CNAME "Directory contains uncommited changes. Autocommiting..."
    hg commit -A -m "Autocommit before pulling from $IPADDR" $CNAME 
  fi

  
  log $CNAME "Pulling config with scp from $IPADDR ... "
  ERRLOG="/tmp/scp.${CNAME////}.$EPOCH"
  mkdir -p $CNAME/etc.$EPOCH/
  scp -pr $IPADDR:"$BACKUP_FILELIST" $CNAME/etc.$EPOCH/ >/dev/null 2>$ERRLOG 
  RETVAL=$?
  rmdir --ignore-fail-on-non-empty $CNAME/etc.$EPOCH/
  [ -s $ERRLOG ] && log $CNAME "scp: $(<$ERRLOG)"
  [ $RETVAL -ne 0 ] && return

  [ -d $CNAME/etc ] && rm -r $CNAME/etc
  mv $CNAME/etc.$EPOCH $CNAME/etc

  log $CNAME "Done."
  
}

tstamp () {
  date +%F_%T
}

log () {
  CNAME="$1"
  TEXT="$2"
  echo "[$CNAME] $(tstamp): $TEXT"
}
 
pushConfigs () {

  [ $# -eq 0 ] && usage

  until [ $# -eq 0 ] ; do
    ARG="$1"
    shift
  
    case "$ARG" in
      -i|--ip ) IPADDR=$1 ; shift ;;
      -w|--wait ) if [ -z "${1//[0-9]/}" ] ; then REBOOT_WAIT=$1 ; shift ; else usage ; fi ;;
      -n|--no-reboot ) REBOOT_CMD="/bin/true" ;;
      * )
        CNAME="$ARG"
  
        if ! [ -d $CNAME ] ; then log $CNAME "Directory doesn't exist!" ; unset IPADDR ; continue ; fi
  
        [ -n "$IPADDR" ] || IPADDR=$(getIpFromCname $CNAME)
  
        pushConfigToIp $CNAME $IPADDR &
        
        unset IPADDR
      ;;
    esac
  
  done

}

pullConfigs () {

  [ $# -eq 0 ] && usage

  until [ $# -eq 0 ] ; do
    ARG="$1"
    shift
  
    case "$ARG" in
      -i|--ip ) IPADDR=$1 ; shift ;;
      * )
        CNAME="$ARG"
  
        if ! [ -d $CNAME ] && [ -z $IPADDR ] ; then 
	  log $CNAME "Directory doesn't exist! Please prepend --ip to specify where to pull from."
	  continue
	fi
	
        [ -n "$IPADDR" ] || IPADDR=$(getIpFromCname $CNAME)
  
        pullConfigFromIp $CNAME $IPADDR &
        
        unset IPADDR
      ;;
    esac
  
  done

}

confirmConfigs () {
  # TODO , ssh $1 "rm -r /etc.failsafe"
  exit 1
}

case $1 in
  push )
    shift
    pushConfigs $*
  ;;
  pull )
    shift
    pullConfigs $*
  ;;
  confirm )
    shift
    confirmConfigs $*
  ;;
  * )
    usage
  ;;
esac

log "*" "All jobs started."
wait
